{{- define "title" }}Notes - {{ .Site.Title }}{{ end -}}

{{- define "content" -}}

{{- /* Collect all tags and categories from posts */ -}}
{{- $allTags := slice -}}
{{- $allCats := slice -}}
{{- range .Site.RegularPages -}}
    {{- if eq .Type "posts" -}}
        {{- range .Params.tags -}}
            {{- $allTags = $allTags | append . -}}
        {{- end -}}
        {{- range .Params.categories -}}
            {{- $allCats = $allCats | append . -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- $allTags = $allTags | uniq | sort -}}
{{- $allCats = $allCats | uniq | sort -}}

<div class="page single special blog-list-page">
    <div class="blog-layout">

        {{- /* ── Sidebar ── */ -}}
        <aside class="blog-sidebar">
            <p class="blog-sidebar-desc">Things I figured out, things I'm still figuring out, and the occasional rant about tools that are 90% of the way there.</p>
            <p class="blog-sidebar-sub">{{ len .Pages }} posts</p>

            {{- if $allCats -}}
            <div class="blog-filter-group">
                <span class="blog-filter-label">Category</span>
                <div class="blog-filter-list">
                    <button class="blog-filter-btn active" data-filter="cat" data-value="all">all</button>
                    {{- range $allCats -}}
                    <button class="blog-filter-btn" data-filter="cat" data-value="{{ . }}">{{ . }}</button>
                    {{- end -}}
                </div>
            </div>
            {{- end -}}

            {{- if $allTags -}}
            <div class="blog-filter-group">
                <span class="blog-filter-label">Tags</span>
                <div class="blog-filter-list">
                    <button class="blog-filter-btn active" data-filter="tag" data-value="all">all</button>
                    {{- range $allTags -}}
                    <button class="blog-filter-btn" data-filter="tag" data-value="{{ . }}">{{ . }}</button>
                    {{- end -}}
                </div>
            </div>
            {{- end -}}

            <div class="blog-sidebar-browse">
                <a href="/tags/">all tags</a>
                <a href="/categories/">all categories</a>
            </div>
        </aside>

        {{- /* ── Posts ── */ -}}
        <div class="blog-main">
            <div class="blog-cards" id="blog-cards">
                {{- range .Pages.ByDate.Reverse -}}
                <article class="blog-card"
                    data-tags="{{ delimit .Params.tags "," }}"
                    data-cats="{{ delimit .Params.categories "," }}">
                    <a href="{{ .RelPermalink }}" class="blog-card-link">
                        <div class="blog-card-meta">
                            <time class="blog-card-date">{{ .PublishDate.Format "Jan 2, 2006" }}</time>
                            <span class="blog-card-read">{{ .ReadingTime }} min read</span>
                        </div>
                        <h2 class="blog-card-title">{{ .Title | emojify }}</h2>
                        <p class="blog-card-desc">{{ .Description | default (.Summary | plainify | truncate 160) }}</p>
                        <div class="blog-card-tags">
                            {{- range .Params.categories -}}
                            <span class="blog-card-tag blog-card-tag--cat">{{ . }}</span>
                            {{- end -}}
                            {{- range .Params.tags -}}
                            <span class="blog-card-tag">{{ . }}</span>
                            {{- end -}}
                        </div>
                    </a>
                </article>
                {{- end -}}
            </div>

            <p class="blog-empty" id="blog-empty" style="display:none">No posts match this filter.</p>

            {{- if not .Pages -}}
            <p class="blog-empty">No posts yet. Check back soon.</p>
            {{- end -}}
        </div>

    </div>
</div>

<script>
(function () {
    var activeCat = 'all';
    var activeTag = 'all';

    // Parse hash: #tag=python or #cat=engineering or #tag=python&cat=engineering
    function parseHash() {
        var hash = window.location.hash.replace('#', '');
        var params = {};
        hash.split('&').forEach(function (part) {
            var kv = part.split('=');
            if (kv.length === 2) params[kv[0]] = decodeURIComponent(kv[1]);
        });
        return params;
    }

    function updateHash() {
        var parts = [];
        if (activeCat !== 'all') parts.push('cat=' + encodeURIComponent(activeCat));
        if (activeTag !== 'all') parts.push('tag=' + encodeURIComponent(activeTag));
        history.replaceState(null, '', parts.length ? '#' + parts.join('&') : window.location.pathname);
    }

    function applyFilters() {
        var cards = document.querySelectorAll('.blog-card');
        var shown = 0;
        cards.forEach(function (card) {
            var cats = card.dataset.cats ? card.dataset.cats.split(',') : [];
            var tags = card.dataset.tags ? card.dataset.tags.split(',') : [];
            var show = (activeCat === 'all' || cats.indexOf(activeCat) !== -1)
                    && (activeTag === 'all' || tags.indexOf(activeTag) !== -1);
            card.style.display = show ? '' : 'none';
            if (show) shown++;
        });
        var empty = document.getElementById('blog-empty');
        if (empty) empty.style.display = shown === 0 ? '' : 'none';

        // Sync button active states
        document.querySelectorAll('.blog-filter-btn').forEach(function (btn) {
            var match = (btn.dataset.filter === 'cat' && btn.dataset.value === activeCat)
                     || (btn.dataset.filter === 'tag' && btn.dataset.value === activeTag);
            btn.classList.toggle('active', match);
        });
    }

    // Init from hash on load
    var initial = parseHash();
    activeCat = initial.cat || 'all';
    activeTag = initial.tag || 'all';
    applyFilters();

    document.querySelectorAll('.blog-filter-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var f = btn.dataset.filter, v = btn.dataset.value;
            if (f === 'cat') activeCat = (activeCat === v) ? 'all' : v;
            if (f === 'tag') activeTag = (activeTag === v) ? 'all' : v;
            updateHash();
            applyFilters();
        });
    });
})();
</script>
{{- end -}}
